[[data]]
= Spring Data 통합

Spring Security는 현재 사용자를 쿼리 내에서 참조할 수 있게 해주는 Spring Data 통합을 제공합니다.
이는 유용할 뿐만 아니라, 페이지 처리된 결과를 지원하기 위해 필수적입니다. 결과를 나중에 필터링하는 것은 확장성이 떨어지기 때문입니다.

[[data-configuration]]
== Spring Data & Spring Security 설정

이 지원을 사용하려면 `org.springframework.security:spring-security-data` 의존성을 추가하고 `SecurityEvaluationContextExtension` 타입의 빈을 제공해야 합니다.
Java 설정에서는 다음과 같이 작성합니다:

[tabs]
======
Java::
+
[source,java,role="primary"]
----
@Bean
public SecurityEvaluationContextExtension securityEvaluationContextExtension() {
	return new SecurityEvaluationContextExtension();
}
----

Kotlin::
+
[source,kotlin,role="secondary"]
----
@Bean
fun securityEvaluationContextExtension(): SecurityEvaluationContextExtension {
    return SecurityEvaluationContextExtension()
}
----
======

XML 설정에서는 다음과 같이 작성합니다:

[source,xml]
----
<bean class="org.springframework.security.data.repository.query.SecurityEvaluationContextExtension"/>
----

[[data-query]]
== @Query 내의 보안 표현식

이제 Spring Security를 쿼리 내에서 사용할 수 있습니다.
예를 들어:

[tabs]
======
Java::
+
[source,java,role="primary"]
----
@Repository
public interface MessageRepository extends PagingAndSortingRepository<Message,Long> {
	@Query("select m from Message m where m.to.id = ?#{ principal?.id }")
	Page<Message> findInbox(Pageable pageable);
}
----

Kotlin::
+
[source,kotlin,role="secondary"]
----
@Repository
interface MessageRepository : PagingAndSortingRepository<Message?, Long?> {
    @Query("select m from Message m where m.to.id = ?#{ principal?.id }")
    fun findInbox(pageable: Pageable?): Page<Message?>?
}
----
======

이는 ``Authentication.getPrincipal().getId()``가 ``Message``의 수신자와 동일한지 확인합니다.
이 예제는 id 속성을 가진 객체로 principal을 사용자 정의했다고 가정합니다.
``SecurityEvaluationContextExtension`` 빈을 노출함으로써, 모든 xref:servlet/authorization/method-security.adoc#authorization-expressions[일반 보안 표현식]을 쿼리 내에서 사용할 수 있습니다.