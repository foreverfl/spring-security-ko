= 설정 마이그레이션

다음 단계들은 `HttpSecurity`, `WebSecurity` 및 관련 컴포넌트의 설정 방식 변경과 관련된 내용입니다.

== Lambda DSL 사용하기

Lambda DSL은 Spring Security 5.2 버전부터 도입되어 람다를 사용해 HTTP 보안을 설정할 수 있게 해줍니다.

Spring Security 문서나 샘플에서 이러한 설정 스타일을 보셨을 것입니다.
HTTP 보안의 람다 설정이 이전 설정 스타일과 어떻게 다른지 살펴보겠습니다.

[source,java]
.람다를 사용한 설정
----
@Configuration
@EnableWebSecurity
public class SecurityConfig {

    @Bean
    public SecurityFilterChain filterChain(HttpSecurity http) throws Exception {
        http
            .authorizeHttpRequests(authorize -> authorize
                .requestMatchers("/blog/**").permitAll()
                .anyRequest().authenticated()
            )
            .formLogin(formLogin -> formLogin
                .loginPage("/login")
                .permitAll()
            )
            .rememberMe(Customizer.withDefaults());

        return http.build();
    }
}
----

[source,java]
.람다를 사용하지 않은 동일한 설정
----
@Configuration
@EnableWebSecurity
public class SecurityConfig {

    @Bean
    public SecurityFilterChain filterChain(HttpSecurity http) throws Exception {
        http
            .authorizeHttpRequests()
                .requestMatchers("/blog/**").permitAll()
                .anyRequest().authenticated()
                .and()
            .formLogin()
                .loginPage("/login")
                .permitAll()
                .and()
            .rememberMe();

        return http.build();
    }
}
----

Lambda DSL은 Spring Security를 설정하는 권장 방식입니다. 이전 설정 스타일은 Spring Security 7에서는 유효하지 않을 것이며, Lambda DSL 사용이 필수가 될 것입니다.
이는 주로 다음과 같은 이유로 결정되었습니다:

- 이전 방식에서는 반환 타입을 알지 않고는 어떤 객체가 설정되고 있는지 명확하지 않았습니다.
중첩이 깊어질수록 더욱 혼란스러워졌습니다.
경험 많은 사용자조차도 자신의 설정이 실제로는 다른 동작을 하고 있음에도 불구하고 의도한 대로 동작한다고 생각하곤 했습니다.

- 일관성.
많은 코드베이스에서 두 스타일을 번갈아 사용하여 설정을 이해하기 어렵게 만들고 종종 잘못된 설정으로 이어졌습니다.

=== Lambda DSL 설정 팁

위의 두 샘플을 비교해보면 몇 가지 주요 차이점을 알 수 있습니다:

- Lambda DSL에서는 ``.and()`` 메서드를 사용하여 설정 옵션을 연결할 필요가 없습니다.
람다 메서드 호출 후 자동으로 `HttpSecurity` 인스턴스가 반환되어 추가 설정이 가능합니다.

- ``Customizer.withDefaults()``는 Spring Security에서 제공하는 기본값을 사용하여 보안 기능을 활성화합니다.
이는 람다 표현식 ``it -> {}``의 단축형입니다.

=== WebFlux Security

WebFlux Security도 비슷한 방식으로 람다를 사용하여 설정할 수 있습니다.
아래는 람다를 사용한 설정 예시입니다.

[source,java]
.람다를 사용한 WebFlux 설정
----
@Configuration
@EnableWebFluxSecurity
public class SecurityConfig {

    @Bean
    public SecurityWebFilterChain springSecurityFilterChain(ServerHttpSecurity http) {
        http
            .authorizeExchange(exchanges -> exchanges
                .pathMatchers("/blog/**").permitAll()
                .anyExchange().authenticated()
            )
            .httpBasic(Customizer.withDefaults())
            .formLogin(formLogin -> formLogin
                .loginPage("/login")
            );

        return http.build();
    }

}
----

=== Lambda DSL의 목표

Lambda DSL은 다음과 같은 목표를 달성하기 위해 만들어졌습니다:

- 자동 들여쓰기로 설정의 가독성이 향상됩니다.
- ``.and()``를 사용하여 설정 옵션을 연결할 필요가 없습니다.
- Spring Security DSL은 Spring Integration 및 Spring Cloud Gateway와 같은 다른 Spring DSL과 유사한 설정 스타일을 가집니다.

== 커스텀 DSL에 `.apply()` 대신 `.with()` 사용하기

6.2 버전 이전에는 xref:servlet/configuration/java.adoc#jc-custom-dsls[커스텀 DSL]이 있는 경우 `HttpSecurity#apply(...)` 메서드를 사용하여 ``HttpSecurity``에 적용했습니다.
그러나 6.2 버전부터 이 메서드는 더 이상 사용되지 않으며 7.0에서는 제거될 예정입니다. 이는 ``.and()``가 제거되면 ``.and()``를 사용한 설정 연결이 더 이상 불가능해지기 때문입니다 (https://github.com/spring-projects/spring-security/issues/13067 참조).
대신 새로운 ``.with(...)`` 메서드를 사용하는 것이 권장됩니다.
``.with(...)``의 사용 방법에 대한 자세한 정보는 xref:servlet/configuration/java.adoc#jc-custom-dsls[커스텀 DSL 섹션]을 참조하세요.